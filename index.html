<!doctype html>
<html>
  <head>
    <script async src="https://news.google.com/swg/js/v1/swg-gaa.js"></script>
    <script async subscriptions-control="manual" src="https://news.google.com/swg/js/v1/swg.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "NewsArticle",
      "isAccessibleForFree": false,
      "isPartOf": {
        "@type": ["CreativeWork", "Product"],
        "name" : "The Example Times",
        "productID": "example.com:showcase"
      },
      "publisher": {
        "@type": "Organization",
        "name": "The Example Times"
      }
    }
    </script>
  </head>
  <body>
    <script>
      // A Client ID looks like the following example:
      const googleApiClientId = '123456789123-xxxxx.apps.googleusercontent.com';

      // Array with all allowed hosts that can refer users to your article pages.
      const allowedReferrers = ["example.com", "test.com", "localhost"];

      // The userState object for the current user.
      function getUserState() {
        return {
          id: 'user123456789',
          registrationTimestamp: 1647311022,
          subscriptionTimestamp: 1647311062,
          granted: true,
          grantReason: 'SUBSCRIBER'
        };
      };

      /**
       * Publisher-defined callbacks.
       *
       * The simplest possible implementation of showPaywall, unlockArticle, openLoginPage
       * and handleSwGEntitlement. A more sophisticated implementation could fetch more data,
       * or set cookies and refresh the whole page.
       */

      // Callback that must ensure the publisher’s standard paywall is shown to the user.
      // This is used when Extended Access is not granted to the user or if the user
      // clicks “Subscribe” on the Extended Access prompt.
      function showPaywall() {
        console.log('Example: show paywall');
      };

      // Callback that must unlock the current article which is called when Google is
      // granting Extended Access to the user.
      function unlockArticle() {
        console.log('Example: unlock article');
      };

      // Only relevant for publishers doing Subscribe with Google.
      // Callback that will be triggered if the user is a Subscribe with Google subscriber.
      function handleSwGEntitlement() {
        console.log('Example: handle swg entitlement');
        unlockArticle();
      }

      /*
       * Publisher-defined promises.
       *
       * The simplest implementation of registerUserPromise, handleLoginPromise,
       * and publisherEntitlementPromise.
       */

      // Get userState by passing the gaaUser object to your registration endpoint server
      // Takes the registration JWT and returns an updated userState object for the newly
      // registered user.
      registerUserPromise = new Promise((resolve) => {
        GaaMetering.getGaaUserPromise().then((gaaUser) => {
          // gaaUser - registration JWT that is returned by Sign In with Google
          // https://developers.google.com/identity/gsi/web/reference/js-reference#credential
          const gaaUserDecoded = decodeJwtResponse(gaaUser.credential);

          // Register user on your side

          // resolve with the userState object of this new user
          resolve(userStateRegisteredUser);
        });
      });

      function decodeJwtResponse(payload) {
        // decodeJwtResponse() is a custom function defined by you
        // to decode the credential response.

        // You can validate and decode the JWT credential by using a
        // JWT-decoding library for your language - https://jwt.io/

        return payloadDecoded;
      }

      // Allows the user to login to an existing publisher account and must resolve
      // with an updated userState object for the newly logged-in user.
      handleLoginPromise = new Promise((resolve) => {
        // Open the login page form or redirect the user to the login page

        // Resolve with an updated userState object for the newly logged-in user
        resolve(userStateLoggedInUser);
      });

      // Get userState by passing the gaaUser object to your registration endpoint server
      // Resolves with the current user’s entitlements (userState object) from the publisher
      // Optional - required only if your userState object doesn't contain the
      // publisherEntitlement already
      publisherEntitlementPromise = new Promise((resolve) => {
        // Fetch the userState object from the server

        // Resolve with the current user’s entitlements (userState object)
        resolve(userStatePublisherEntitlement);
      });

      GaaMetering.init({
        googleApiClientId: googleApiClientId,
        allowedReferrers: allowedReferrers,
        userState: getUserState(),
        unlockArticle: unlockArticle,
        showPaywall: showPaywall,
        registerUserPromise: registerUserPromise,
        handleLoginPromise: handleLoginPromise,
        publisherEntitlementPromise: publisherEntitlementPromise, // Optional
        handleSwGEntitlement: handleSwGEntitlement, // Optional - only if SwG is implemented
      });
    </script>
  </body>
</html>
